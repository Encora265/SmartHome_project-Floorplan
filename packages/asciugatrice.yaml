###############################################################################
# PACKAGE: Gestione Asciugatrice CANDY GOC780BT
###############################################################################

homeassistant:
  customize:
    binary_sensor.asciugatrice_in_funzione:
      friendly_name: Asciugatrice in funzione
    input_datetime.asciugatrice_inizio_programma:
      icon: mdi:clock-start
    input_datetime.asciugatrice_fine_programma:
      icon: mdi:clock-end
    input_number.asciugatrice_consumo_ultimo_ciclo:
      icon: mdi:lightning-bolt

###############################################################################
# SENSORI - Potenza ‚Üí Consumo Ciclo (kWh)
###############################################################################
sensor:
  - platform: integration
    source: sensor.sonoff_1001d8e7f6_power_2
    name: "Asciugatrice Consumo Ciclo"
    unit_prefix: k
    round: 3
    method: left
    unit_time: h

###############################################################################
# UTILITY METER - Resettabile manualmente all'inizio di ogni ciclo
###############################################################################
utility_meter:
  asciugatrice_ciclo:
    source: sensor.asciugatrice_consumo_ciclo

  asciugatrice_consumo_giornaliero:
    source: sensor.asciugatrice_consumo_ciclo
    cycle: daily

  asciugatrice_consumo_settimanale:
    source: sensor.asciugatrice_consumo_ciclo
    cycle: weekly

  asciugatrice_consumo_mensile:
    source: sensor.asciugatrice_consumo_ciclo
    cycle: monthly

  asciugatrice_consumo_annuale:
    source: sensor.asciugatrice_consumo_ciclo
    cycle: yearly

###############################################################################
# INPUT DATETIME e INPUT NUMBER per memorizzare dati ultimo ciclo
###############################################################################
input_datetime:
  asciugatrice_inizio_programma:
    name: Inizio programma
    has_date: true
    has_time: true
  asciugatrice_fine_programma:
    name: Fine programma
    has_date: true
    has_time: true

input_number:
  asciugatrice_consumo_ultimo_ciclo:
    name: Consumo ultimo ciclo
    min: 0
    max: 20
    step: 0.01
    unit_of_measurement: "kWh"

  asciugatrice_cicli_totali:
    name: Cicli totali asciugatrice
    unit_of_measurement: "cicli"
    min: 0
    max: 100000
    step: 1

  asciugatrice_consumo_totale:
    name: Consumo totale asciugatrice
    unit_of_measurement: "kWh"
    min: 0
    max: 100000
    step: 0.001

  asciugatrice_costo_totale:
    name: Costo totale asciugatrice
    unit_of_measurement: "‚Ç¨"
    min: 0
    max: 100000
    step: 0.01

  asciugatrice_tempo_totale:
    name: Tempo totale asciugatrice
    unit_of_measurement: "min"
    min: 0
    max: 1000000
    step: 1
    
###############################################################################
# INPUT BOOLEAN per toggle notifiche
###############################################################################
input_boolean:
  asciugatrice_notifiche_abilitate:
    name: Notifiche Asciugatrice
    icon: mdi:bell-ring
    initial: true

  asciugatrice_notifiche_vocali_abilitate:
    name: Notifiche Vocali Nest Hub
    icon: mdi:google-assistant
    initial: true
    
  asciugatrice_notifiche_manutenzione_abilitate:
    name: Notifiche Manutenzione
    icon: mdi:tools
    initial: true

###############################################################################
# COUNTER dei cicli di asciugatura
###############################################################################
counter:
  asciugatrice_cicli_giornalieri:
    name: Cicli Giornalieri Asciugatrice
    icon: mdi:calendar-today
    restore: false

  asciugatrice_cicli_settimanali:
    name: Cicli Settimanali Asciugatrice
    icon: mdi:calendar-week
    restore: false

  asciugatrice_cicli_mensili:
    name: Cicli Mensili Asciugatrice
    icon: mdi:calendar-month
    restore: false

  asciugatrice_cicli_annuali:
    name: Cicli Annuali Asciugatrice
    icon: mdi:calendar-multiple
    restore: false

  asciugatrice_cicli_totali:
    name: Cicli asciugatrice totali
    initial: 0
    step: 1

###############################################################################
# COUNTER manutenzione
###############################################################################
  asciugatrice_cicli_da_pulizia_filtri:
    name: Cicli da ultima pulizia filtri
    icon: mdi:air-filter
    initial: 0
    step: 1

  asciugatrice_cicli_da_pulizia_condensatore:
    name: Cicli da ultima pulizia condensatore
    icon: mdi:radiator
    initial: 0
    step: 1

  asciugatrice_cicli_da_svuotamento_serbatoio:
    name: Cicli da ultimo svuotamento serbatoio
    icon: mdi:water
    initial: 0
    step: 1

###############################################################################
# SENSORI TEMPLATE
###############################################################################
template:
  - binary_sensor:
      - name: "Asciugatrice in funzione"
        unique_id: asciugatrice_in_funzione
        state: "{{ states('sensor.sonoff_1001d8e7f6_power_2') | float(0) > 2 }}"
        device_class: running
        icon: >
          {% if is_state('binary_sensor.asciugatrice_in_funzione', 'on') %}
            mdi:tumble-dryer
          {% else %}
            mdi:tumble-dryer-off
          {% endif %}

  - sensor:
      # Orario e durata ultimo ciclo
      - name: "Ora ultimo avvio asciugatrice"
        unique_id: ora_ultimo_avvio_asciugatrice
        device_class: timestamp
        state: >
          {% set val = states('input_datetime.asciugatrice_inizio_programma') %}
          {{ val if val not in ['unknown', 'unavailable', 'none', 'None'] else none }}

      - name: "Durata ultimo ciclo asciugatrice"
        unique_id: durata_ultimo_ciclo_asciugatrice
        unit_of_measurement: "min"
        icon: mdi:timer-outline
        state: >
          {% set start = states('input_datetime.asciugatrice_inizio_programma') %}
          {% set end = states('input_datetime.asciugatrice_fine_programma') %}
          {% if start not in ['unknown', 'unavailable', 'none', 'None']
                and end not in ['unknown', 'unavailable', 'none', 'None'] %}
            {{ ((as_datetime(end) - as_datetime(start)).total_seconds() / 60) | round(0) }}
          {% else %}
            0
          {% endif %}

      # Costo ultimo ciclo
      - name: "Costo ultimo ciclo asciugatrice"
        unique_id: costo_ultimo_ciclo_asciugatrice
        unit_of_measurement: "‚Ç¨"
        icon: mdi:currency-eur
        state: >
          {% set consumo = states('input_number.asciugatrice_consumo_ultimo_ciclo') | float(0) %}
          {% set prezzo = states('input_number.costo_energia') | float(0) %}
          {{ (consumo * prezzo) | round(2) if prezzo > 0 else 0.0 }}

      # Costo giornaliero
      - name: "Costo giornaliero asciugatrice"
        unique_id: costo_giornaliero_asciugatrice
        unit_of_measurement: "‚Ç¨"
        icon: mdi:currency-eur
        state: >
          {% set consumo = states('sensor.asciugatrice_consumo_giornaliero') | float(0) %}
          {% set prezzo = states('input_number.costo_energia') | float(0) %}
          {{ (consumo * prezzo) | round(2) if prezzo > 0 else 0.0 }}

      # Costo settimanale
      - name: "Costo settimanale asciugatrice"
        unique_id: costo_settimanale_asciugatrice
        unit_of_measurement: "‚Ç¨"
        icon: mdi:currency-eur
        state: >
          {% set consumo = states('sensor.asciugatrice_consumo_settimanale') | float(0) %}
          {% set prezzo = states('input_number.costo_energia') | float(0) %}
          {{ (consumo * prezzo) | round(2) if prezzo > 0 else 0.0 }}

      # Costo mensile e annuale
      - name: "Costo Mensile Asciugatrice"
        unique_id: costo_mensile_asciugatrice
        unit_of_measurement: "‚Ç¨"
        icon: mdi:calendar-month
        state: >
          {% set consumo = states('sensor.consumo_asciugatrice_mese') | float(0) %}
          {% set prezzo = states('input_number.costo_energia') | float(0) %}
          {{ (consumo * prezzo) | round(2) if prezzo > 0 else 0.0 }}

      - name: "Costo Annuale Asciugatrice"
        unique_id: costo_annuale_asciugatrice
        unit_of_measurement: "‚Ç¨"
        icon: mdi:calendar
        state: >
          {% set consumo = states('sensor.consumo_asciugatrice_anno') | float(0) %}
          {% set prezzo = states('input_number.costo_energia') | float(0) %}
          {{ (consumo * prezzo) | round(2) if prezzo > 0 else 0.0 }}

      # Sensori cicli
      - name: "Cicli Asciugatrice Oggi"
        unique_id: cicli_asciugatrice_oggi
        icon: mdi:calendar-today
        unit_of_measurement: "cicli"
        state: "{{ states('counter.asciugatrice_cicli_giornalieri') | int(0) }}"

      - name: "Cicli Asciugatrice Settimana"
        unique_id: cicli_asciugatrice_settimana
        icon: mdi:calendar-week
        unit_of_measurement: "cicli"
        state: "{{ states('counter.asciugatrice_cicli_settimanali') | int(0) }}"

      - name: "Cicli Asciugatrice Mese"
        unique_id: cicli_asciugatrice_mese
        icon: mdi:calendar-month
        unit_of_measurement: "cicli"
        state: "{{ states('counter.asciugatrice_cicli_mensili') | int(0) }}"

      - name: "Cicli Asciugatrice Anno"
        unique_id: cicli_asciugatrice_anno
        icon: mdi:calendar
        unit_of_measurement: "cicli"
        state: "{{ states('counter.asciugatrice_cicli_annuali') | int(0) }}"

      - name: "Cicli Asciugatrice Totali"
        unique_id: cicli_asciugatrice_totali
        icon: mdi:counter
        unit_of_measurement: "cicli"
        state: "{{ states('counter.asciugatrice_cicli_totali') | int(0) }}"

      # Sensori consumo
      - name: "Consumo Asciugatrice Oggi"
        unique_id: consumo_asciugatrice_oggi
        state: "{{ states('sensor.asciugatrice_consumo_giornaliero') | float(0) }}"
        unit_of_measurement: "kWh"
        icon: mdi:flash

      - name: "Consumo Asciugatrice Settimana"
        unique_id: consumo_asciugatrice_settimana
        state: "{{ states('sensor.asciugatrice_consumo_settimanale') | float(0) }}"
        unit_of_measurement: "kWh"
        icon: mdi:flash

      - name: "Consumo Asciugatrice Mese"
        unique_id: consumo_asciugatrice_mese
        state: "{{ states('sensor.asciugatrice_consumo_mensile') | float(0) }}"
        unit_of_measurement: "kWh"
        icon: mdi:flash

      - name: "Consumo Asciugatrice Anno"
        unique_id: consumo_asciugatrice_anno
        state: "{{ states('sensor.asciugatrice_consumo_annuale') | float(0) }}"
        unit_of_measurement: "kWh"
        icon: mdi:flash

      - name: "Consumo Totale Asciugatrice"
        unique_id: consumo_totale_asciugatrice
        state: "{{ states('input_number.asciugatrice_consumo_totale') | float(0) }}"
        unit_of_measurement: "kWh"
        icon: mdi:flash

###############################################################################
# SENSORI TEMPLATE MANUTENZIONE
###############################################################################
      - name: "Stato Pulizia Filtri"
        unique_id: stato_pulizia_filtri
        state: >
          {% set cicli = states('counter.asciugatrice_cicli_da_pulizia_filtri') | int(0) %}
          {% if cicli >= 1 %}Necessaria{% else %}OK{% endif %}
        icon: >
          {% set cicli = states('counter.asciugatrice_cicli_da_pulizia_filtri') | int(0) %}
          {% if cicli >= 1 %}mdi:alert-circle{% else %}mdi:check-circle{% endif %}

      - name: "Stato Pulizia Condensatore"
        unique_id: stato_pulizia_condensatore
        state: >
          {% set cicli = states('counter.asciugatrice_cicli_da_pulizia_condensatore') | int(0) %}
          {% if cicli >= 10 %}Necessaria{% elif cicli >= 7 %}In scadenza{% else %}OK{% endif %}
        icon: >
          {% set cicli = states('counter.asciugatrice_cicli_da_pulizia_condensatore') | int(0) %}
          {% if cicli >= 10 %}mdi:alert-circle{% elif cicli >= 7 %}mdi:alert{% else %}mdi:check-circle{% endif %}

      - name: "Stato Svuotamento Serbatoio"
        unique_id: stato_svuotamento_serbatoio
        state: >
          {% set cicli = states('counter.asciugatrice_cicli_da_svuotamento_serbatoio') | int(0) %}
          {% if cicli >= 1 %}Necessario{% else %}OK{% endif %}
        icon: >
          {% set cicli = states('counter.asciugatrice_cicli_da_svuotamento_serbatoio') | int(0) %}
          {% if cicli >= 1 %}mdi:alert-circle{% else %}mdi:check-circle{% endif %}

###############################################################################
# AUTOMAZIONI
###############################################################################
automation:
  # Inizio asciugatura
  - alias: "Asciugatrice - Inizio asciugatura"
    id: asciugatrice_inizio_asciugatura
    trigger:
      - platform: state
        entity_id: binary_sensor.asciugatrice_in_funzione
        from: "off"
        to: "on"
    action:
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.asciugatrice_inizio_programma
        data:
          datetime: "{{ now().strftime('%Y-%m-%d %H:%M:%S') }}"
      - service: utility_meter.reset
        target:
          entity_id: utility_meter.asciugatrice_ciclo

  # Fine asciugatura
  - alias: "Asciugatrice - Fine asciugatura"
    id: asciugatrice_fine_asciugatura
    trigger:
      - platform: state
        entity_id: binary_sensor.asciugatrice_in_funzione
        from: "on"
        to: "off"
        for:
          minutes: 2
    action:
      - service: input_number.set_value
        target:
          entity_id: input_number.asciugatrice_consumo_ultimo_ciclo
        data:
          value: "{{ states('sensor.asciugatrice_ciclo') | float(0) }}"
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.asciugatrice_fine_programma
        data:
          datetime: "{{ now().strftime('%Y-%m-%d %H:%M:%S') }}"
      - service: counter.increment
        target:
          entity_id:
            - counter.asciugatrice_cicli_giornalieri
            - counter.asciugatrice_cicli_settimanali
            - counter.asciugatrice_cicli_mensili
            - counter.asciugatrice_cicli_annuali
            - counter.asciugatrice_cicli_totali
            - counter.asciugatrice_cicli_da_pulizia_filtri
            - counter.asciugatrice_cicli_da_pulizia_condensatore
            - counter.asciugatrice_cicli_da_svuotamento_serbatoio
      - service: input_number.set_value
        target:
          entity_id: input_number.asciugatrice_consumo_totale
        data:
          value: >
            {{ states('input_number.asciugatrice_consumo_totale') | float(0)
               + states('input_number.asciugatrice_consumo_ultimo_ciclo') | float(0) }}
      - service: input_number.set_value
        target:
          entity_id: input_number.asciugatrice_costo_totale
        data:
          value: >
            {{ states('input_number.asciugatrice_costo_totale') | float(0)
               + states('sensor.costo_ultimo_ciclo_asciugatrice') | float(0) }}
      - service: input_number.set_value
        target:
          entity_id: input_number.asciugatrice_tempo_totale
        data:
          value: >
            {{ states('input_number.asciugatrice_tempo_totale') | float(0)
               + states('sensor.durata_ultimo_ciclo_asciugatrice') | float(0) }}
      - variables:
          volume_attuale: "{{ state_attr('media_player.nesthube6f7', 'volume_level') | float(0.3) }}"
      - service: media_player.volume_set
        target:
          entity_id: media_player.nesthube6f7
        data:
          volume_level: 0.7
      - service: tts.cloud_say
        target:
          entity_id: media_player.nesthube6f7
        data:
          message: >
            {{ [
              "L'asciugatura √® terminata.",
              "L'asciugatrice ha concluso il ciclo.",
              "Il programma √® completato."
            ] | random }}
            Il consumo dell'ultimo ciclo √® stato di 
            {{ states('input_number.asciugatrice_consumo_ultimo_ciclo') | float(0) | round(2) }} kilowattora,
            per un costo stimato di 
            {{ states('sensor.costo_ultimo_ciclo_asciugatrice') | float(0) | round(2) }} euro.
            Ricordati di svuotare il serbatoio e pulire i filtri!
          language: "it-IT"
      - delay: "00:00:05"
      - service: media_player.volume_set
        target:
          entity_id: media_player.nesthube6f7
        data:
          volume_level: "{{ volume_attuale }}"
      - service: notify.mobile_app_enrico_phone
        data:
          title: "Asciugatrice"
          message: >
            Il ciclo dell'asciugatrice √® terminato!
            Consumo: {{ states('input_number.asciugatrice_consumo_ultimo_ciclo') }} kWh
            Costo: {{ states('sensor.costo_ultimo_ciclo_asciugatrice') }} ‚Ç¨
            
  # Reset contatori giornalieri
  - alias: "Asciugatrice - Reset contatore giornaliero"
    id: asciugatrice_reset_giornaliero
    trigger:
      - platform: time
        at: "00:00:00"
    action:
      - service: counter.reset
        target:
          entity_id: counter.asciugatrice_cicli_giornalieri

  # Reset contatore settimanale
  - alias: "Asciugatrice - Reset contatore settimanale"
    id: asciugatrice_reset_settimanale
    trigger:
      - platform: time
        at: "00:00:00"
    condition:
      - condition: template
        value_template: "{{ now().weekday() == 0 }}"
    action:
      - service: counter.reset
        target:
          entity_id: counter.asciugatrice_cicli_settimanali

  # Reset contatore mensile
  - alias: "Asciugatrice - Reset contatore mensile"
    id: asciugatrice_reset_mensile
    trigger:
      - platform: time
        at: "00:00:00"
    condition:
      - condition: template
        value_template: "{{ now().day == 1 }}"
    action:
      - service: counter.reset
        target:
          entity_id: counter.asciugatrice_cicli_mensili

  # Reset contatore annuale
  - alias: "Asciugatrice - Reset contatore annuale"
    id: asciugatrice_reset_annuale
    trigger:
      - platform: time
        at: "00:00:00"
    condition:
      - condition: template
        value_template: "{{ now().month == 1 and now().day == 1 }}"
    action:
      - service: counter.reset
        target:
          entity_id: counter.asciugatrice_cicli_annuali

###############################################################################
# AUTOMAZIONI manutenzione
###############################################################################
  # Alert Pulizia Filtri
  - alias: "Asciugatrice - Alert Pulizia Filtri"
    id: asciugatrice_alert_pulizia_filtri
    trigger:
      - platform: numeric_state
        entity_id: counter.asciugatrice_cicli_da_pulizia_filtri
        above: 0
    condition:
      - condition: state
        entity_id: input_boolean.asciugatrice_notifiche_manutenzione_abilitate
        state: 'on'
    action:
      - condition: state
        entity_id: input_boolean.asciugatrice_notifiche_abilitate
        state: 'on'
      - service: notify.mobile_app_enrico_phone
        data:
          title: "üîß Asciugatrice - Manutenzione"
          message: "Ricordati di pulire i filtri interni ed esterni!"

  # Alert Pulizia Condensatore
  - alias: "Asciugatrice - Alert Pulizia Condensatore"
    id: asciugatrice_alert_pulizia_condensatore
    trigger:
      - platform: numeric_state
        entity_id: counter.asciugatrice_cicli_da_pulizia_condensatore
        above: 9
    condition:
      - condition: state
        entity_id: input_boolean.asciugatrice_notifiche_manutenzione_abilitate
        state: 'on'
    action:
      - condition: state
        entity_id: input_boolean.asciugatrice_notifiche_abilitate
        state: 'on'
      - service: notify.mobile_app_enrico_phone
        data:
          title: "üå°Ô∏è Asciugatrice - Manutenzione"
          message: "√à ora di pulire il condensatore con spazzola o aspirapolvere!"
      - condition: state
        entity_id: input_boolean.asciugatrice_notifiche_vocali_abilitate
        state: 'on'
      - service: tts.cloud_say
        target:
          entity_id: media_player.nesthube6f7
        data:
          message: "Attenzione: √® ora di pulire il condensatore dell'asciugatrice."
          language: "it-IT"

  # Alert Svuotamento Serbatoio
  - alias: "Asciugatrice - Alert Svuotamento Serbatoio"
    id: asciugatrice_alert_svuotamento_serbatoio
    trigger:
      - platform: numeric_state
        entity_id: counter.asciugatrice_cicli_da_svuotamento_serbatoio
        above: 0
    condition:
      - condition: state
        entity_id: input_boolean.asciugatrice_notifiche_manutenzione_abilitate
        state: 'on'
    action:
      - condition: state
        entity_id: input_boolean.asciugatrice_notifiche_abilitate
        state: 'on'
      - service: notify.mobile_app_enrico_phone
        data:
          title: "üíß Asciugatrice - Manutenzione"
          message: "Ricordati di svuotare il serbatoio dell'acqua!"

###############################################################################
# SCRIPT
###############################################################################
script:
  asciugatrice_reset_totali:
    alias: "Reset Statistiche Totali Asciugatrice"
    sequence:
      - service: input_number.set_value
        target:
          entity_id:
            - input_number.asciugatrice_consumo_totale
            - input_number.asciugatrice_costo_totale
            - input_number.asciugatrice_tempo_totale
        data:
          value: 0
      - service: counter.reset
        target:
          entity_id: counter.asciugatrice_cicli_totali
      - service: notify.mobile_app_enrico_phone
        data:
          title: "Asciugatrice"
          message: "Statistiche totali azzerate con successo!"

  asciugatrice_pulizia_filtri_completata:
    alias: "Pulizia Filtri Completata"
    sequence:
      - service: counter.reset
        target:
          entity_id: counter.asciugatrice_cicli_da_pulizia_filtri
      - service: notify.mobile_app_enrico_phone
        data:
          title: "üîß Asciugatrice"
          message: "Pulizia filtri registrata!"

  asciugatrice_pulizia_condensatore_completata:
    alias: "Pulizia Condensatore Completata"
    sequence:
      - service: counter.reset
        target:
          entity_id: counter.asciugatrice_cicli_da_pulizia_condensatore
      - service: notify.mobile_app_enrico_phone
        data:
          title: "üå°Ô∏è Asciugatrice"
          message: "Pulizia condensatore registrata! Prossima tra 10 cicli."

  asciugatrice_svuotamento_serbatoio_completato:
    alias: "Svuotamento Serbatoio Completato"
    sequence:
      - service: counter.reset
        target:
          entity_id: counter.asciugatrice_cicli_da_svuotamento_serbatoio
      - service: notify.mobile_app_enrico_phone
        data:
          title: "üíß Asciugatrice"
          message: "Svuotamento serbatoio registrato!"

  asciugatrice_popup:
    alias: "Mostra popup asciugatrice"
    sequence:
      - action: browser_mod.popup
        data:
          size: normal
          timeout: 0
          content:
            type: entities
            card_mod:
              style: |
                .card-header {
                  padding: 0px !important;
                }
            show_header_toggle: false
            entities:
              - type: section
                label: Asciugatrice CANDY GOC780BT
              - type: custom:hui-element
                card_type: vertical-stack
                cards:
                  - type: horizontal-stack
                    cards:
                      - type: picture-entity
                        entity: binary_sensor.asciugatrice_in_funzione
                        show_name: false
                        show_state: false
                        fit_mode: contain
                        state_image:
                          "on": /local/elettrodomestici/asciugatrice_on.gif
                          "off": /local/elettrodomestici/asciugatrice_off.png
                        card_mod:
                          style: |
                            ha-card {
                              --ha-card-border-width: 0px;
                              margin: 0px;
                              padding: 10px;
                              background: none;
                              {% if is_state('binary_sensor.asciugatrice_in_funzione', 'on') %}
                                filter: drop-shadow(0 0 15px rgba(255, 152, 0, 0.6));
                                animation: pulse 2s ease-in-out infinite;
                              {% endif %}
                            }
                            @keyframes pulse {
                              0%, 100% { filter: drop-shadow(0 0 10px rgba(255, 152, 0, 0.4)); }
                              50% { filter: drop-shadow(0 0 20px rgba(255, 152, 0, 0.8)); }
                            }

                      - type: vertical-stack
                        cards:
                          - type: custom:button-card
                            entity: input_datetime.asciugatrice_inizio_programma
                            icon: mdi:clock-start
                            show_name: false
                            show_icon: true
                            show_state: true
                            show_label: true
                            label: >
                              [[[ 
                                const e = states['input_datetime.asciugatrice_inizio_programma'];
                                if (!e || e.state === 'unknown' || e.state === '') return '-';
                                const d = new Date(e.state.replace(' ', 'T'));
                                return d.toLocaleDateString('it-IT') + ' ' + d.toLocaleTimeString('it-IT', {hour:'2-digit', minute:'2-digit'});
                              ]]]
                            state_display: 'Inizio ultimo ciclo'
                            styles:
                              grid:
                                - grid-template-areas: '"i l" "i s"'
                                - grid-template-columns: 40px 1fr
                                - grid-template-rows: auto auto
                                - row-gap: 2px
                              card:
                                - "--ha-card-background": rgba(0,0,0,0)
                                - "--ha-card-box-shadow": none
                                - padding: 8px
                                - height: auto
                              icon:
                                - color: var(--primary-text-color)
                                - width: 30px
                                - height: 30px
                              label:
                                - font-size: 14px
                                - justify-self: start
                                - white-space: nowrap
                                - color: >
                                    [[[
                                      const e = states['input_datetime.asciugatrice_inizio_programma'];
                                      if (!e || e.state === 'unknown' || e.state === '') return 'var(--secondary-text-color)';
                                      return 'var(--primary-text-color)';
                                    ]]]
                              state:
                                - font-size: 12px
                                - justify-self: start
                                - color: var(--secondary-text-color)

                          - type: custom:button-card
                            entity: input_datetime.asciugatrice_fine_programma
                            icon: mdi:clock-end
                            show_name: false
                            show_icon: true
                            show_state: true
                            show_label: true
                            label: >
                              [[[ 
                                const e = states['input_datetime.asciugatrice_fine_programma'];
                                if (!e || e.state === 'unknown' || e.state === '') return '-';
                                const d = new Date(e.state.replace(' ', 'T'));
                                return d.toLocaleDateString('it-IT') + ' ' + d.toLocaleTimeString('it-IT',{hour:'2-digit', minute:'2-digit'});
                              ]]]
                            state_display: 'Fine ultimo ciclo'
                            styles:
                              grid:
                                - grid-template-areas: '"i l" "i s"'
                                - grid-template-columns: 40px 1fr
                                - grid-template-rows: auto auto
                                - row-gap: 2px
                              card:
                                - "--ha-card-background": rgba(0,0,0,0)
                                - "--ha-card-box-shadow": none
                                - padding: 8px
                                - height: auto
                              icon:
                                - color: var(--primary-text-color)
                                - width: 30px
                                - height: 30px
                              label:
                                - font-size: 14px
                                - justify-self: start
                                - white-space: nowrap
                              state:
                                - font-size: 12px
                                - justify-self: start
                                - color: var(--secondary-text-color)

                          - type: custom:button-card
                            entity: sensor.durata_ultimo_ciclo_asciugatrice
                            icon: mdi:timer-outline
                            show_name: false
                            show_icon: true
                            show_state: true
                            show_label: true
                            label: >
                              [[[ 
                                const e = states['sensor.durata_ultimo_ciclo_asciugatrice'];
                                if (!e || e.state === 'unknown' || e.state === '' || e.state === 'unavailable' || e.state === '0') return '-';
                                const minuti = parseInt(e.state);
                                if (isNaN(minuti) || minuti === 0) return '-';
                                const ore = Math.floor(minuti / 60);
                                const min = minuti % 60;
                                if (ore > 0) return ore + 'h ' + min + 'min';
                                return min + ' min';
                              ]]]
                            state_display: 'Durata ultimo ciclo'
                            styles:
                              grid:
                                - grid-template-areas: '"i l" "i s"'
                                - grid-template-columns: 40px 1fr
                                - grid-template-rows: auto auto
                                - row-gap: 2px
                              card:
                                - "--ha-card-background": rgba(0,0,0,0)
                                - "--ha-card-box-shadow": none
                                - padding: 8px
                                - height: auto
                              icon:
                                - color: var(--primary-text-color)
                                - width: 30px
                                - height: 30px
                              label:
                                - font-size: 14px
                                - justify-self: start
                                - white-space: nowrap
                              state:
                                - font-size: 12px
                                - justify-self: start
                                - color: var(--secondary-text-color)

                          - type: custom:button-card
                            entity: input_number.asciugatrice_consumo_ultimo_ciclo
                            icon: mdi:flash
                            show_name: false
                            show_icon: true
                            show_state: true
                            show_label: true
                            label: >
                              [[[ return states['input_number.asciugatrice_consumo_ultimo_ciclo'].state + ' kWh'; ]]]
                            state_display: 'Ultimo consumo'
                            styles:
                              grid:
                                - grid-template-areas: '"i l" "i s"'
                                - grid-template-columns: 40px 1fr
                                - grid-template-rows: auto auto
                                - row-gap: 2px
                              card:
                                - "--ha-card-background": rgba(0,0,0,0)
                                - "--ha-card-box-shadow": none
                                - padding: 8px
                                - height: auto
                              icon:
                                - color: var(--primary-text-color)
                                - width: 30px
                                - height: 30px
                              label:
                                - font-size: 14px
                                - justify-self: start
                                - white-space: nowrap
                              state:
                                - font-size: 12px
                                - justify-self: start
                                - color: var(--secondary-text-color)

                          - type: custom:button-card
                            entity: sensor.costo_ultimo_ciclo_asciugatrice
                            icon: mdi:currency-eur
                            show_name: false
                            show_icon: true
                            show_state: true
                            show_label: true
                            label: >
                              [[[ return states['sensor.costo_ultimo_ciclo_asciugatrice'].state + ' ‚Ç¨'; ]]]
                            state_display: 'Costo ultimo ciclo'
                            styles:
                              grid:
                                - grid-template-areas: '"i l" "i s"'
                                - grid-template-columns: 40px 1fr
                                - grid-template-rows: auto auto
                                - row-gap: 2px
                              card:
                                - "--ha-card-background": rgba(0,0,0,0)
                                - "--ha-card-box-shadow": none
                                - padding: 8px
                                - height: auto
                              icon:
                                - color: var(--primary-text-color)
                                - width: 30px
                                - height: 30px
                              label:
                                - font-size: 14px
                                - justify-self: start
                                - white-space: nowrap
                              state:
                                - font-size: 12px
                                - justify-self: start
                                - color: var(--secondary-text-color)

                  - type: custom:bar-card
                    entity: sensor.sonoff_1001d8e7f6_power_2
                    name: Consumo Istantaneo
                    max: 2500
                    unit_of_measurement: W
                    show_icon: true
                    align: split
                    columns: 1
                    positions:
                      icon: inside
                      indicator: inside
                      name: inside
                      value: inside
                    severity:
                      - color: "#00e676"
                        from: 0
                        to: 5
                      - color: "#ff9800"
                        from: 6
                        to: 1500
                      - color: "#f44336"
                        from: 1501
                        to: 4000
                    animation:
                      - state: "on"
                        color: "#ff9800"
                    card_mod:
                      style: |
                        ha-card {
                          --ha-card-background: rgba(0,0,0,0);
                          --ha-card-box-shadow: none;
                        }
                        bar-card-currentbar, bar-card-backgroundbar {
                          border-radius: 10px !important;
                        }
                        bar-card-currentbar {
                          background: linear-gradient(90deg, 
                            var(--bar-color) 0%, 
                            var(--bar-color) 100%) !important;
                          box-shadow: 0 0 10px var(--bar-color) !important;
                          transition: all 0.3s ease !important;
                        }

                  - type: custom:paper-buttons-row
                    buttons:
                      - icon: hass:cog-outline
                        tap_action:
                          action: fire-dom-event
                          browser_mod:
                            service: browser_mod.popup
                            data:
                              title: Impostazioni
                              style: |
                                --popup-background-color: var(--secondary-background-color);
                                --dialog-backdrop-filter: blur(2em) brightness(0.75);
                              content:
                                type: vertical-stack
                                cards:
                                  - type: entities
                                    entities:
                                      - entity: switch.sonoff_1001d8e7f6_2
                                        name: Alimentazione Asciugatrice
                                        icon: mdi:power-socket-eu
                                      - entity: binary_sensor.asciugatrice_in_funzione
                                      - type: divider
                                      - entity: input_boolean.asciugatrice_notifiche_abilitate
                                        name: Notifiche Push
                                        icon: mdi:cellphone-message
                                      - entity: input_boolean.asciugatrice_notifiche_vocali_abilitate
                                        name: Notifiche Vocali Nest Hub
                                        icon: mdi:google-assistant
                                      - entity: input_boolean.asciugatrice_notifiche_manutenzione_abilitate
                                        name: Alert Manutenzione
                                        icon: mdi:tools
                                      - type: divider
                                      - entity: input_number.costo_energia
                                      - type: divider
                                      - type: section
                                        label: üîß Stato Manutenzioni
                                      - entity: sensor.stato_pulizia_filtri
                                        name: Pulizia Filtri
                                        secondary_info: Dopo ogni ciclo
                                      - entity: sensor.stato_pulizia_condensatore
                                        name: Pulizia Condensatore
                                      - entity: sensor.stato_svuotamento_serbatoio
                                        name: Svuotamento Serbatoio
                                        secondary_info: Dopo ogni ciclo
                                      - type: divider
                                      - type: button
                                        name: Reset Statistiche Totali
                                        icon: mdi:refresh
                                        action_name: RESET
                                        tap_action:
                                          action: call-service
                                          service: script.asciugatrice_reset_totali
                                          confirmation:
                                            text: "Sei sicuro di voler azzerare tutte le statistiche totali?"
                                  - type: custom:paper-buttons-row
                                    buttons:
                                      - icon: mdi:arrow-left
                                        name: Indietro
                                        tap_action:
                                          action: call-service
                                          service: script.asciugatrice_popup
                                        style:
                                          button:
                                            width: 100%

                      - icon: hass:chart-bar
                        tap_action:
                          action: fire-dom-event
                          browser_mod:
                            service: browser_mod.popup
                            data:
                              title: Statistiche Asciugatrice
                              style: |
                                --popup-background-color: var(--secondary-background-color);
                                --dialog-backdrop-filter: blur(2em) brightness(0.75);
                              content:
                                type: vertical-stack
                                cards:
                                  - type: custom:swipe-card
                                    start_card: 0
                                    parameters:
                                      grabCursor: true
                                      spaceBetween: 10
                                      effect: slide
                                    cards:
                                      - type: markdown
                                        content: |
                                          ## üìä Statistiche Consumo Asciugatrice
                                            
                                          ### Oggi
                                          - **Cicli:** {{ states('sensor.cicli_asciugatrice_oggi') }}
                                          - **Consumo:** {{ states('sensor.consumo_asciugatrice_oggi') }} kWh
                                          - **Costo:** {{ states('sensor.costo_giornaliero_asciugatrice') }} ‚Ç¨
                                                
                                          ### Settimana
                                          - **Cicli:** {{ states('sensor.cicli_asciugatrice_settimana') }}
                                          - **Consumo:** {{ states('sensor.consumo_asciugatrice_settimana') }} kWh
                                          - **Costo:** {{ states('sensor.costo_settimanale_asciugatrice') }} ‚Ç¨
                                                
                                          ### Mese
                                          - **Cicli:** {{ states('sensor.cicli_asciugatrice_mese') }}
                                          - **Consumo:** {{ states('sensor.consumo_asciugatrice_mese') }} kWh
                                          - **Costo:** {{ states('sensor.costo_mensile_asciugatrice') }} ‚Ç¨
                                                
                                          ### Anno
                                          - **Cicli:** {{ states('sensor.cicli_asciugatrice_anno') }}
                                          - **Consumo:** {{ states('sensor.consumo_asciugatrice_anno') }} kWh
                                          - **Costo:** {{ states('sensor.costo_annuale_asciugatrice') }} ‚Ç¨
                                                
                                          ---
                                                
                                          ### üèÜ Totali Assoluti
                                          - **Cicli totali:** {{ states('sensor.cicli_asciugatrice_totali') }}
                                          - **Consumo totale:** {{ states('sensor.consumo_totale_asciugatrice') }} kWh
                                          - **Costo totale:** {{ states('input_number.asciugatrice_costo_totale') }} ‚Ç¨
                                          - **Tempo totale:** {{ (states('input_number.asciugatrice_tempo_totale') | float / 60) | round(1) }} ore

                                      - type: vertical-stack
                                        cards:
                                          - type: custom:apexcharts-card
                                            header:
                                              show: true
                                              title: "üìà Consumo Mese Corrente"
                                            graph_span: 31d
                                            span:
                                              start: month
                                            series:
                                              - entity: sensor.asciugatrice_consumo_giornaliero
                                                name: Consumo Giornaliero (kWh)
                                                type: column
                                                group_by:
                                                  func: max
                                                  duration: 1d
                                            apex_config:
                                              chart:
                                                height: 260
                                              plotOptions:
                                                bar:
                                                  borderRadius: 6
                                              xaxis:
                                                labels:
                                                  show: true
                                            yaxis:
                                              - decimals: 2
                                                min: 0
                       
                                          - type: custom:apexcharts-card
                                            header:
                                              show: true
                                              title: "üí∂ Costo Mese Corrente"
                                            graph_span: 31d
                                            span:
                                              start: month
                                            series:
                                              - entity: sensor.costo_giornaliero_asciugatrice
                                                name: Costo Giornaliero (‚Ç¨)
                                                type: column
                                                group_by:
                                                  func: max
                                                  duration: 1d
                                            apex_config:
                                              chart:
                                                height: 260
                                              plotOptions:
                                                bar:
                                                  borderRadius: 6
                                              xaxis:
                                                labels:
                                                  show: true
                                            yaxis:
                                              - decimals: 2
                                                min: 0
                        
                                      - type: vertical-stack
                                        cards:
                                          - type: custom:apexcharts-card
                                            header:
                                              show: true
                                              title: "üìÖ Consumo Storico Annuale"
                                            graph_span: 10y
                                            series:
                                              - entity: sensor.asciugatrice_consumo_annuale
                                                name: Consumo Annuale (kWh)
                                                type: column
                                                group_by:
                                                  func: last
                                                  duration: 1y
                                            apex_config:
                                              chart:
                                                height: 260
                                              plotOptions:
                                                bar:
                                                  borderRadius: 6
                                              xaxis:
                                                labels:
                                                  show: true
                                            yaxis:
                                              - decimals: 2
                                                min: 0
                        
                                          - type: custom:apexcharts-card
                                            header:
                                              show: true
                                              title: "üè¶ Costo Storico Annuale"
                                            graph_span: 10y
                                            series:
                                              - entity: sensor.costo_annuale_asciugatrice
                                                name: Costo Annuale (‚Ç¨)
                                                type: column
                                                group_by:
                                                  func: last
                                                  duration: 1y
                                            apex_config:
                                              chart:
                                                height: 260
                                              plotOptions:
                                                bar:
                                                  borderRadius: 6
                                              xaxis:
                                                labels:
                                                  show: true
                                            yaxis:
                                              - decimals: 2
                                                min: 0
                        
                                  - type: custom:paper-buttons-row
                                    buttons:
                                      - icon: mdi:arrow-left
                                        name: Indietro
                                        tap_action:
                                          action: call-service
                                          service: script.asciugatrice_popup
                                        style:
                                          button:
                                            width: 100%

                      - icon: hass:tools
                        tap_action:
                          action: fire-dom-event
                          browser_mod:
                            service: browser_mod.popup
                            data:
                              title: Manutenzione Asciugatrice
                              size: wide
                              style: |
                                --popup-background-color: var(--secondary-background-color);
                                --dialog-backdrop-filter: blur(2em) brightness(0.75);
                                --popup-max-width: 1000px;
                                --popup-min-height: 600px;
                              content:
                                type: vertical-stack
                                cards:
                                  - type: grid
                                    columns: 3
                                    square: false
                                    cards:
                                      - type: entities
                                        entities:
                                          - type: section
                                            label: üîß Pulizia Filtri (ogni ciclo)
                                          - entity: counter.asciugatrice_cicli_da_pulizia_filtri
                                            name: Cicli dall'ultima pulizia
                                            icon: mdi:counter
                                          - entity: sensor.stato_pulizia_filtri
                                            name: Stato
                                          - type: button
                                            name: Filtri puliti
                                            icon: mdi:air-filter
                                            action_name: FATTO
                                            tap_action:
                                              action: call-service
                                              service: script.asciugatrice_pulizia_filtri_completata
                        
                                      - type: entities
                                        entities:
                                          - type: section
                                            label: üå°Ô∏è Pulizia Condensatore (ogni 10 cicli)
                                          - entity: counter.asciugatrice_cicli_da_pulizia_condensatore
                                            name: Cicli dall'ultima pulizia
                                            icon: mdi:counter
                                          - entity: sensor.stato_pulizia_condensatore
                                            name: Stato
                                          - type: button
                                            name: Condensatore pulito
                                            icon: mdi:radiator
                                            action_name: FATTO
                                            tap_action:
                                              action: call-service
                                              service: script.asciugatrice_pulizia_condensatore_completata
                        
                                      - type: entities
                                        entities:
                                          - type: section
                                            label: üíß Svuotamento Serbatoio (ogni ciclo)
                                          - entity: counter.asciugatrice_cicli_da_svuotamento_serbatoio
                                            name: Cicli dall'ultimo svuotamento
                                            icon: mdi:counter
                                          - entity: sensor.stato_svuotamento_serbatoio
                                            name: Stato
                                          - type: button
                                            name: Serbatoio svuotato
                                            icon: mdi:water
                                            action_name: FATTO
                                            tap_action:
                                              action: call-service
                                              service: script.asciugatrice_svuotamento_serbatoio_completato

                                  - type: custom:button-card
                                    color_type: blank-card
                                    styles:
                                      card:
                                        - height: 10px

                                  - type: horizontal-stack
                                    cards:
                                      - type: custom:paper-buttons-row
                                        buttons:
                                          - icon: mdi:arrow-left
                                            name: Indietro
                                            tap_action:
                                              action: call-service
                                              service: script.asciugatrice_popup
                                            style:
                                              button:
                                                width: 100%
                        
                                      - type: custom:button-card
                                        color_type: blank

                                      - type: custom:paper-buttons-row
                                        buttons:
                                          - icon: mdi:book-open-variant
                                            name: GUIDA
                                            tap_action:
                                              action: fire-dom-event
                                              browser_mod:
                                                service: browser_mod.popup
                                                data:
                                                  title: Guida Manutenzione
                                                  size: normal
                                                  style: |
                                                    --popup-background-color: var(--secondary-background-color);
                                                    --dialog-backdrop-filter: blur(2em) brightness(0.85);
                                                    --popup-max-width: 700px;
                                                    --popup-min-height: 420px;
                                                  content:
                                                    type: vertical-stack
                                                    cards:
                                                      - type: markdown
                                                        content: |
                                                          ## üìã Guida Manutenzione Asciugatrice
                                        
                                                          **üîß Pulizia Filtri** (dopo ogni ciclo)
                                                          - Filtro interno: rimuovere e lavare sotto acqua corrente, asciugare bene prima di reinserire  
                                                          - Filtro esterno: rimuovere dalla parte inferiore, pulire e asciugare accuratamente  
                                        
                                                          **üå°Ô∏è Pulizia Condensatore** (ogni 10 cicli o quando possibile)
                                                          - Usare spazzola a setole morbide o aspirapolvere  
                                                          - Rimuovere polvere e residui con attenzione  
                                                          - Non piegare le lamelle del condensatore  
                                        
                                                          **üíß Svuotamento Serbatoio** (dopo ogni ciclo)
                                                          - Svuotare il contenitore di raccolta dell'acqua  
                                                          - Previene danni e garantisce funzionamento corretto
                                        
                                                      - type: custom:paper-buttons-row
                                                        buttons:
                                                          - icon: mdi:arrow-left
                                                            name: Indietro
                                                            tap_action:
                                                              action: call-service
                                                              service: script.asciugatrice_popup

                      - icon: hass:information-outline
                        tap_action:
                          action: fire-dom-event
                          browser_mod:
                            service: browser_mod.popup
                            data:
                              title: Info Package
                              style: |
                                --popup-background-color: var(--secondary-background-color);
                                --dialog-backdrop-filter: blur(2em) brightness(0.75);
                              content:
                                type: vertical-stack
                                cards:
                                  - type: markdown
                                    content: |
                                      # üè† Controllo Elettrodomestici
                                      
                                      ## üì¶ Package Asciugatrice
                                      Monitoraggio completo dei consumi e statistiche dell'asciugatrice
                                      
                                      ### ‚ú® Funzionalit√†:
                                      - Tracciamento cicli di asciugatura
                                      - Monitoraggio consumo energetico in tempo reale
                                      - Calcolo automatico dei costi
                                      - Statistiche giornaliere, settimanali, mensili e annuali
                                      - Alert manutenzione programmata
                                      
                                      ---
                                      
                                      ### üì∫ Seguimi su YouTube!
                                      
                                      Per altri progetti, tutorial e guide sulla domotica, visita il mio canale:
                                      
                                      **[SmartHome Project](https://www.youtube.com/channel/UCqftpsaHHm0PCle6vpMvxOg)**
                                      
                                      üîî Iscriviti per non perdere i nuovi video!
                                      
                                      ---
                                      
                                      üí° *Package creato con Home Assistant*
                                  
                                  - type: custom:paper-buttons-row
                                    buttons:
                                      - icon: mdi:arrow-left
                                        name: Indietro
                                        tap_action:
                                          action: call-service
                                          service: script.asciugatrice_popup
                                        style:
                                          button:
                                            width: 100%